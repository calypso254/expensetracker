<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-container {
            transition: all 0.3s ease-in-out;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #message-box {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 50;
            transition: opacity 0.3s, transform 0.3s;
        }
        /* Style for file input */
        input[type="file"]::file-selector-button {
            @apply font-semibold bg-gray-200 text-gray-700 border-0 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-300 transition-colors;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="message-box" class="opacity-0 transform translate-y-[-20px]"></div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Expense Tracker</h1>
            <p class="text-gray-600 mt-2">Log your business and personal expenses with ease.</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8 form-container">
            <form id="expense-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                    <!-- Business -->
                    <div>
                        <label for="business" class="block text-sm font-medium text-gray-700 mb-1">Business / Account</label>
                        <select id="business" name="business" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <option>Personal</option>
                            <option>PenGems</option>
                            <option>Einstein Paper</option>
                            <option>CB&CS</option>
                            <option>CalypsoPixels</option>
                            <option>Cultured Minute</option>
                            <option>Bus2</option>
                            <option>Bus3</option>
                        </select>
                    </div>

                    <!-- Date -->
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" id="date" name="date" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    </div>

                    <!-- Vendor -->
                    <div class="md:col-span-2">
                        <label for="vendor" class="block text-sm font-medium text-gray-700 mb-1">Vendor / Payee</label>
                        <input type="text" id="vendor" name="vendor" required placeholder="e.g., Amazon, Shopify, H-E-B" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    </div>
                    
                    <!-- Amount -->
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount ($)</label>
                        <input type="number" id="amount" name="amount" required placeholder="0.00" step="0.01" min="0" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    </div>

                    <!-- Category -->
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Expense Category</label>
                        <select id="category" name="category" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <option>Advertising & Marketing</option>
                            <option>Bank Charges</option>
                            <option>Commissions & Fees</option>
                            <option>Cost of Goods Sold</option>
                            <option>Dues & Subscriptions</option>
                            <option>Groceries</option>
                            <option>Home</option>
                            <option>Insurance</option>
                            <option>Interest Expense</option>
                            <option>Meals & Entertainment</option>
                            <option>Office Supplies</option>
                            <option>Personal Care</option>
                            <option>Pets</option>
                            <option>Postage & Shipping</option>
                            <option>Professional Fees (Legal, Accounting)</option>
                            <option>Rent or Lease</option>
                            <option>Repairs & Maintenance</option>
                            <option>Software & SaaS</option>
                            <option>Taxes & Licenses</option>
                            <option>Telephone & Internet</option>
                            <option>Transportation</option>
                            <option>Travel</option>
                            <option>Utilities</option>
                            <option>Other</option>
                        </select>
                    </div>

                    <!-- Payment Method -->
                    <div class="md:col-span-2">
                        <label for="payment-method" class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                        <div class="flex gap-2">
                            <input list="payment-methods-list" id="payment-method" name="payment-method" required placeholder="Select or type to add a new one" class="flex-grow w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <datalist id="payment-methods-list"></datalist>
                             <button type="button" id="add-payment-method-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Add</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Examples: PenGems Debit 3776, Personal Discover 4924.</p>
                    </div>

                    <!-- Memo -->
                    <div class="md:col-span-2">
                         <label for="memo" class="block text-sm font-medium text-gray-700 mb-1">Memo / Description</label>
                        <textarea id="memo" name="memo" rows="3" placeholder="What was this for? (e.g., Shipping labels for order #1234)" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"></textarea>
                    </div>

                    <!-- Receipt Upload -->
                    <div class="md:col-span-2">
                        <label for="receipt-file" class="block text-sm font-medium text-gray-700 mb-1">Attach Receipt (Optional)</label>
                        <input type="file" id="receipt-file" name="receipt-file" accept="image/*,.pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
                    </div>


                    <!-- Owner Contribution -->
                    <div id="owner-contribution-container" class="md:col-span-2 flex items-center space-x-3 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                         <input id="owner-contribution" name="owner-contribution" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                         <div>
                            <label for="owner-contribution" class="font-medium text-yellow-800">Paid with personal funds? (Owner Contribution)</label>
                            <p class="text-xs text-yellow-700">Check this if you used a personal card or account for this business expense.</p>
                         </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="mt-8 text-right">
                    <button type="submit" id="submit-btn" class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <span id="submit-btn-text">Save Expense</span>
                        <div id="submit-spinner" class="loader w-5 h-5 rounded-full border-2 border-t-2 border-gray-200 ml-2 hidden"></div>
                    </button>
                </div>
            </form>
        </div>
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>&copy; 2024 Your Business Name. App created by Gemini.</p>
        </footer>
    </div>

    <script>
        // --- CONFIGURATION ---
        // IMPORTANT: Replace with your actual Google Apps Script Web App URL
        const SCRIPT_URL = 'PASTE_YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';
        // --- END CONFIGURATION ---

        const form = document.getElementById('expense-form');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnText = document.getElementById('submit-btn-text');
        const submitSpinner = document.getElementById('submit-spinner');
        const addPaymentBtn = document.getElementById('add-payment-method-btn');
        const paymentMethodInput = document.getElementById('payment-method');
        const paymentMethodsDatalist = document.getElementById('payment-methods-list');
        const dateInput = document.getElementById('date');
        const receiptFileInput = document.getElementById('receipt-file');
        const businessSelect = document.getElementById('business');
        const ownerContributionContainer = document.getElementById('owner-contribution-container');
        const ownerContributionCheckbox = document.getElementById('owner-contribution');
        
        const PAYMENT_METHODS_KEY = 'businessExpenseTrackerPaymentMethods';

        // --- UI Logic ---
        const handleBusinessChange = () => {
            if (businessSelect.value === 'Personal') {
                ownerContributionContainer.style.display = 'none';
                ownerContributionCheckbox.checked = false; // Ensure it's unchecked when hidden
            } else {
                ownerContributionContainer.style.display = 'flex';
            }
        };

        businessSelect.addEventListener('change', handleBusinessChange);


        // --- Payment Method Management ---
        const getPaymentMethods = () => {
            return JSON.parse(localStorage.getItem(PAYMENT_METHODS_KEY)) || [
                'PenGems Expense Debit 3776', 
                'Personal Discover Debit 4924'
            ];
        };

        const savePaymentMethods = (methods) => {
            localStorage.setItem(PAYMENT_METHODS_KEY, JSON.stringify(methods));
        };

        const populatePaymentMethods = () => {
            const methods = getPaymentMethods();
            paymentMethodsDatalist.innerHTML = '';
            methods.forEach(method => {
                const option = document.createElement('option');
                option.value = method;
                paymentMethodsDatalist.appendChild(option);
            });
        };

        const addPaymentMethod = () => {
            const newMethod = paymentMethodInput.value.trim();
            if (newMethod) {
                let methods = getPaymentMethods();
                if (!methods.includes(newMethod)) {
                    methods.push(newMethod);
                    methods.sort();
                    savePaymentMethods(methods);
                    populatePaymentMethods();
                    showMessage(`'${newMethod}' added as a payment method.`, 'success');
                }
                paymentMethodInput.value = newMethod;
            }
        };

        addPaymentBtn.addEventListener('click', addPaymentMethod);

        // --- Message Box Function ---
        const showMessage = (message, type = 'success') => {
            const messageBox = document.getElementById('message-box');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            messageBox.innerHTML = `<div class="${bgColor} text-white font-bold rounded-lg px-4 py-3 shadow-md">${message}</div>`;
            
            messageBox.classList.remove('opacity-0', 'translate-y-[-20px]');
            messageBox.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'translate-y-0');
                messageBox.classList.add('opacity-0', 'translate-y-[-20px]');
            }, 4000);
        };
        
        // --- File to Base64 Converter ---
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- Form Submission ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (SCRIPT_URL === 'https://script.google.com/macros/s/AKfycbxcDJJ7ZPqfVnwTc6yh1HXDSVibS3MsBThniNG5FKMSYgBnzcOx9NRGvjAQQRejP_xR/exec') {
                showMessage('Error: Please configure the SCRIPT_URL in the HTML file.', 'error');
                return;
            }

            // Add new payment method if it doesn't exist
            addPaymentMethod(); 

            // Show loading state
            submitBtn.disabled = true;
            submitBtnText.textContent = 'Saving...';
            submitSpinner.classList.remove('hidden');

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Handle checkbox value
            data['owner-contribution'] = document.getElementById('owner-contribution').checked;
            
            // Set transaction type based on business/personal selection
            if (data.business === 'Personal') {
                 data.transactionType = 'Personal Expense';
            } else {
                 data.transactionType = data['owner-contribution'] ? 'Owner Contribution' : 'Business Expense';
            }

            // Handle file upload
            const file = receiptFileInput.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                     showMessage('Error: Receipt file must be under 5MB.', 'error');
                     submitBtn.disabled = false;
                     submitBtnText.textContent = 'Save Expense';
                     submitSpinner.classList.add('hidden');
                     return;
                }
                const base64File = await toBase64(file);
                data.receiptFile = {
                    base64Data: base64File.split(',')[1],
                    mimeType: file.type,
                    fileName: file.name
                };
            } else {
                data.receiptFile = null;
            }
            delete data['receipt-file']; // remove the file input from the data object

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // Apps Script web apps need this header
                    },
                    body: JSON.stringify(data),
                    redirect: 'follow'
                });
                
                const result = await response.json();

                if (result.status === 'success') {
                    showMessage('Expense saved successfully!', 'success');
                    form.reset();
                    dateInput.valueAsDate = new Date(); // Reset date to today
                    handleBusinessChange(); // Reset UI for owner contribution visibility
                } else {
                    throw new Error(result.message || 'Unknown error occurred.');
                }

            } catch (error) {
                console.error('Error submitting form:', error);
                showMessage(`Error: ${error.message}`, 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtnText.textContent = 'Save Expense';
                submitSpinner.classList.add('hidden');
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            dateInput.valueAsDate = new Date();
            populatePaymentMethods();
            handleBusinessChange(); // Initial check on page load
        });
    </script>
</body>
</html>

